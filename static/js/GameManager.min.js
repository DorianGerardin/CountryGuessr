const countryInput=document.getElementById("countryInput"),countryForm=document.getElementById("countryForm"),countrySubmit=document.getElementById("countrySubmit"),suggestions=document.getElementById("suggestions"),answersContainer=document.getElementById("answersContainer"),answersGrid=document.getElementById("answersGrid"),zoomContainer=document.getElementById("zoomContainer"),zoomButton=document.getElementById("zoomButton"),rulesButton=document.getElementById("rulesButton"),historyButton=document.getElementById("historyButton");let incrementAttempt,getAttemptCount,addShareLine,getShareContent,get5FirstShare,SetSubmittedCountriesToLocalStorage,GetSubmittedCountries,SetSubmittedCountry;function startGame(){let hasWon=!1;return{endGame:function(){hasWon=!0},HasWon:function(){return hasWon}}}!function(){let attempt=0;incrementAttempt=function(){attempt++},getAttemptCount=function(){return attempt}}(),function(){let shareContent="";addShareLine=function(newline){shareContent="\n"+newline+shareContent},getShareContent=function(){return shareContent},get5FirstShare=function(){return"\n"+shareContent.split("\n").slice(1,6).join("\n")+"\n"}}(),function(){let submittedCountries=[];SetSubmittedCountriesToLocalStorage=function(){let history=JSON.parse(localStorage.getItem("history")),key=gameID||dayCount;key in history&&history[key].hasWon||(history[key]??={hasWon:!1,submittedCountries:submittedCountries},history[key].hasWon=!1,history[key].submittedCountries=submittedCountries,localStorage.setItem("history",JSON.stringify(history)),gameID||localStorage.setItem("submittedCountries",JSON.stringify(submittedCountries)))},GetSubmittedCountries=function(){return submittedCountries},SetSubmittedCountry=function(countryCode){submittedCountries.push(countryCode)}}();const game=startGame();let countrySuggestionList,dayCount,countdownInterval,isLoadingCountry=!1,isLoadingCountries=!1,zoomedIn=!1,isZoomDisplayed=!1,hasAlreadyAnswered=!1,currentCountry=null,countriesName=[];function detectGame(){gameID?CheckForHistory(gameID):CheckForHistory()}function UpdateCountdownUntilNextCountry(){let now=new Date,difference=new Date(JSON.parse(localStorage.getItem("expirationDate"))).getTime()-now.getTime(),hours=Math.floor(difference%864e5/36e5),minutes=Math.floor(difference%36e5/6e4),seconds=Math.floor(difference%6e4/1e3),countdownNode=document.getElementById("nextCountryCountdown");const formatTimer=function(hours,minutes,seconds){return`${hours<10?`0${hours}`:hours}:${minutes<10?`0${minutes}`:minutes}:${seconds<10?`0${seconds}`:seconds}`};countdownNode.innerText=`(Il te reste ${formatTimer(hours,minutes,seconds)})`,hours<=0&&minutes<=0&&seconds<=0&&(clearInterval(countdownInterval),countdownNode.innerText=`(Il te reste ${formatTimer(0,0,0)})`,RefreshGame())}function GetCountryPromises(submittedCountries){return submittedCountries.map((countryCode=>SubmitCountry(countryCode)))}async function GetDayCount(){try{const response=await fetch("/dayCount"),data=await response.json();dayCount=data.dayCount}catch(error){console.error(error)}}function CheckForHistory(gameID=null){ToggleLoading(!0),isLoadingCountries=!0,GetDayCount().then((()=>{let submittedCountries,history=JSON.parse(localStorage.getItem("history"));if(history||(localStorage.setItem("history",JSON.stringify({})),history={}),gameID)submittedCountries=gameID in history?history[gameID].submittedCountries:[];else{submittedCountries=JSON.parse(localStorage.getItem("submittedCountries"))||[]}null!==submittedCountries&&Promise.all(GetCountryPromises(submittedCountries)).then((results=>{for(const countryData of results)ResolveCountry(countryData);isLoadingCountries=!1,ToggleLoading(!1)})).catch((error=>{console.error(error)}))}))}function GetTriedCountryBySuggestion(suggestion){suggestion=suggestion.trim();let regExpSuggestion=new RegExp(`^(${suggestion})$`,"giu");return countriesName.filter((country=>{let normalizedCountryName=country.name.normalize("NFD").replace(/[\u0300-\u036f]/g,"");return country.name.match(regExpSuggestion)||country.name.replace(/-/g," ").match(regExpSuggestion)||normalizedCountryName.match(regExpSuggestion)||normalizedCountryName.replace(/-/g," ").match(regExpSuggestion)}))}function GetCountriesBySuggestion(suggestion){suggestion=suggestion.trim();for(let i=0;i<19;i++)if(suggestion.includes("\\{}[]/+*_.|?^&<>!=$"[i]))return[];let regExpSuggestion=new RegExp(`.*${suggestion}.*`,"giu");return countriesName.filter((country=>{let normalizedCountryName=country.name.normalize("NFD").replace(/[\u0300-\u036f]/g,"");return country.name.match(regExpSuggestion)||country.name.replace(/-/g," ").match(regExpSuggestion)||normalizedCountryName.match(regExpSuggestion)||normalizedCountryName.replace(/-/g," ").match(regExpSuggestion)}))}function UpdateSuggestions(event){"input"===event.type&&null!==currentCountry&&(currentCountry=null);const searchText=countryInput.value.trim();countrySuggestionList.Show(GetCountriesBySuggestion(searchText))}function GetAllCountriesName(){fetch("/AllCountriesName").then((response=>response.json())).then((data=>{404===data.status?console.log("aucun pays trouvé"):(countriesName=JSON.parse(data),countrySuggestionList=new CountrySuggestionList(countriesName,suggestions,countryInput),countryForm.style.display="flex")}))}function TrySubmitCountry(event){"Enter"===event.key&&countrySuggestionList.IsEmpty()&&(event.preventDefault(),SubmitCountry(currentCountry).then((countryData=>{ResolveCountry(countryData)})))}function ResolveCountry(countryData){if(null===countryData)return;incrementAttempt(),hasAlreadyAnswered||(answersContainer.style.display="flex"),currentCountry=null,hasAlreadyAnswered=!0;let country=JSON.parse(countryData);Clue.UpdateCluesAttempts(),SetSubmittedCountry(country.code),SetSubmittedCountriesToLocalStorage(),ShowZoomButton(),CreateAnswerRow(country),country.isAnswer&&(game.endGame(),countryForm.remove())}function RefreshGame(){alert("Un nouveau pays a été sélectionné. La page va se recharger"),ClearLocalStorage(),window.location.reload()}function ToggleLoading(setOn){isLoadingCountries||(setOn?(isLoadingCountry=!0,countrySubmit.innerHTML="",countrySubmit.classList.add("loading")):(isLoadingCountry=!1,countrySubmit.classList.remove("loading"),countrySubmit.innerHTML="Deviner"))}async function SubmitCountry(countryCode){let expirationDate=new Date(JSON.parse(localStorage.getItem("expirationDate")));if(null!==expirationDate&&expirationDate<new Date&&RefreshGame(),game.HasWon())return Promise.resolve(null);if(!countryCode)return DisplayToast("Pays introuvable !","./static/images/alert.svg"),Promise.resolve(null);countryInput.value="",ToggleLoading(!0);let defaultFetchURL=`/guess?code=${countryCode}`;return gameID&&(defaultFetchURL+=`&game=${gameID}`),new Promise(((resolve,reject)=>{fetch(defaultFetchURL).then((response=>response.json())).then((data=>{ToggleLoading(!1),resolve(data)})).catch((error=>{reject("Une erreur s'est produite :",error)}))}))}function WinGame(countryData){if(!countryData.isAnswer)return void console.log("Nope");Clue.UnlockAllClues();let attemptCount=getAttemptCount(),attemptsElements=document.getElementsByClassName("ggAttemptsCounts");for(let i=0;i<attemptsElements.length;i++)attemptsElements[i].innerText=attemptCount;let history=JSON.parse(localStorage.getItem("history")),gameKey=gameID||dayCount;document.getElementById("dayCount").innerText=gameKey;let usedClueCount,clueUsedCountNode=document.getElementById("clueUsedCount");usedClueCount=gameID?history[gameID].UsedClueCount||0:Clue.UsedClueCount(),clueUsedCountNode.innerText=usedClueCount,document.getElementById("indices").innerText=usedClueCount>1?"indices":"indice",document.getElementById("essai").innerText=attemptCount>1?"essais":"essai";let shareContent=getShareContent(),shareContentElement=document.getElementById("shareContent");shareContentElement.innerHTML+=attemptCount>5?get5FirstShare()+`+ ${attemptCount-5} de plus`:shareContent,document.getElementById("copyButton").addEventListener("click",(()=>{let copyText=shareContentElement.textContent+"\nhttps://countryguessr.mrdo.fr";navigator.clipboard.writeText(copyText).then((function(){DisplayToast("Copié !","./static/images/clipboard.png")})).catch((function(err){DisplayToast("Erreur","./static/images/alert.svg")}))})),document.getElementById("shareButton").addEventListener("click",(()=>{const shareData={title:"Country Guessr",text:shareContentElement.textContent+"\nhttps://countryguessr.mrdo.fr"};navigator.share(shareData).then((r=>{DisplayToast("Partagé !",null)})).catch((function(err){DisplayToast("Erreur","./static/images/alert.svg")}))}));let ggFlagImg=document.getElementById("ggFlagImg");ggFlagImg.alt=countryData.flagAlt;let ggCountryName=document.getElementById("ggCountryName");ggFlagImg.src=`./static/images/flags/${countryData.code}.svg`,ggCountryName.innerText=countryData.name;let ggContainer=document.getElementById("ggContainer");ggContainer.style.display="flex",ggContainer.scrollIntoView({behavior:"smooth"}),ggContainer.animate([{transform:"scale(1)"},{transform:"scale(1.05)"}],{duration:250,iterations:6,direction:"alternate",easing:"ease-in-out"});let nameNodes=document.getElementsByClassName("answer0");for(let i=0;i<nameNodes.length;i++)nameNodes[i].style.cursor="pointer";document.getElementById("ggFlag").addEventListener("click",(()=>{window.open(countryData.maps,"_blank")})),document.getElementById("wikipediaLink").addEventListener("click",(()=>{window.open(countryData.wikiLink,"_blank")})),history[gameKey].hasWon=!0,localStorage.setItem("history",JSON.stringify(history))}function DisplayToast(text,avatar){let toast;toast=avatar?Toastify({text:text,duration:1500,gravity:"top",position:"center",avatar:avatar,className:"toast",stopOnFocus:!1,onClick:function(){toast.hideToast()}}):Toastify({text:text,duration:1500,gravity:"top",position:"center",className:"toast",stopOnFocus:!1,onClick:function(){toast.hideToast()}}),toast.showToast()}function CreateAnswerSquare(answerNumber,rowNode,textValue,ratio){let squareNode=document.createElement("div"),squareContentNode=document.createElement("div");squareNode.classList.add("answerSquare"),squareNode.classList.add(`answer${answerNumber}`),squareNode.style.opacity="0",squareContentNode.classList.add("answerContent"),squareContentNode.innerText=textValue;return PickColor(squareNode,ratio,[.55,.75,1]),squareNode.appendChild(squareContentNode),rowNode.appendChild(squareNode),squareNode}function CreateArrowSquare(answerNumber,rowNode,textValue,ratio,equals,isDistance=!1,isBorder=!1){let squareNode=document.createElement("div"),squareContentNode=document.createElement("div");squareNode.classList.add("answerSquare"),squareNode.classList.add(`answer${answerNumber}`),squareNode.style.opacity="0",squareContentNode.classList.add("answerContent"),squareContentNode.innerText=numberWithSpaces(textValue);let borderColorThresholds=[.25,.5,1],basicColorThresholds=[.55,.75,1];return isDistance?PickColor(squareNode,ratio,[.575,.75,.85]):isBorder?(AddArrowIndicator(equals,squareContentNode),PickColor(squareNode,ratio,borderColorThresholds)):(AddArrowIndicator(equals,squareContentNode),PickColor(squareNode,ratio,basicColorThresholds)),squareNode.appendChild(squareContentNode),rowNode.appendChild(squareNode),squareNode}function AnimateAnswerRow(answerRow,country,index){const fadeIn=[{opacity:"0",scale:"0.6"},{opacity:"1",scale:"1"}],fadeInTiming={duration:600,iterations:1,easing:"ease-in-out",fill:"forwards"};let squareNodes=answerRow.childNodes;index<squareNodes.length?setTimeout((function(){squareNodes[index].animate(fadeIn,fadeInTiming),AnimateAnswerRow(answerRow,country,index+1)}),330):setTimeout((function(){country.isAnswer&&WinGame(country)}),700)}function CreateAnswerRow(countryData){let answerRow=document.createElement("div");answerRow.classList.add("answerRow");let newLineEmojis="",nameNode=document.createElement("div"),nameContentNode=document.createElement("div");nameNode.classList.add("answerSquare"),nameNode.classList.add("answer0"),nameNode.addEventListener("click",(()=>{game.HasWon()&&window.open(countryData.maps,"_blank")})),nameContentNode.classList.add("answerContent");let flagBG=document.createElement("div");flagBG.classList.add("backgroundFlag"),flagBG.style.backgroundImage=`url(./static/images/flags/${countryData.code}.svg)`,nameContentNode.innerText=countryData.name,nameContentNode.appendChild(flagBG),nameNode.appendChild(nameContentNode),answerRow.appendChild(nameNode);let continentRatio=countryData.continent.isEqual?1:0;newLineEmojis+=getEmojiByColor(CreateAnswerSquare(1,answerRow,countryData.continent.value,continentRatio).classList);let languageRatio=countryData.language.isEqual?1:0;newLineEmojis+=getEmojiByColor(CreateAnswerSquare(2,answerRow,countryData.language.value,languageRatio).classList),newLineEmojis+=getEmojiByColor(CreateArrowSquare(3,answerRow,countryData.populationCount.value,countryData.populationCount.ratio,countryData.populationCount.isEqual).classList);let currencyRatio=countryData.currency.isEqual?1:0;newLineEmojis+=getEmojiByColor(CreateAnswerSquare(4,answerRow,countryData.currency.value,currencyRatio).classList),newLineEmojis+=getEmojiByColor(CreateArrowSquare(5,answerRow,countryData.borderCount.value,countryData.borderCount.ratio,countryData.borderCount.isEqual,!1,!0).classList),newLineEmojis+=getEmojiByColor(CreateArrowSquare(6,answerRow,countryData.area.value,countryData.area.ratio,countryData.area.isEqual).classList),newLineEmojis+=getEmojiByColor(CreateArrowSquare(7,answerRow,countryData.distance.value,countryData.distance.ratio,!1,!0).classList),addShareLine(newLineEmojis),answersGrid.prepend(answerRow),adjustTextSize(answerRow),AnimateAnswerRow(answerRow,countryData,1)}function getEmojiByColor(classList){return classList.contains("badAnswer")?"🟥":classList.contains("answerPercent25_50")?"🟧":classList.contains("answerPercent50_75")?"🟨":"🟩"}function numberWithSpaces(x){return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g," ")}function AddArrowIndicator(value,node){let upArrow=document.createElement("div");upArrow.classList.add("backgroundArrow"),upArrow.style.backgroundImage='url("./static/images/up_arrow.png")';let downArrow=document.createElement("div");downArrow.classList.add("backgroundArrow"),downArrow.style.backgroundImage='url("./static/images/down_arrow.png")',"="!==value&&node.appendChild("+"===value?upArrow:downArrow)}function PickColor(node,ratio,thresholds){let answerColorClass=ratio<thresholds[0]?"badAnswer":ratio<thresholds[1]?"answerPercent25_50":ratio<thresholds[2]?"answerPercent50_75":"goodAnswer";node.classList.add(answerColorClass)}function adjustTextSize(answerRow){let containers=void 0!==answerRow?answerRow.querySelectorAll(".answerSquare"):document.getElementsByClassName("answerSquare");for(const answerSquare of containers){if(!(answerSquare.classList.contains("answer0")||answerSquare.classList.contains("answer1")||answerSquare.classList.contains("answer2")||answerSquare.classList.contains("answer3")||answerSquare.classList.contains("answer4")||answerSquare.classList.contains("answer6")))continue;answerSquare.style.removeProperty("fontSize");let defaultFontSize=parseFloat(getComputedStyle(document.getElementById("answersContainer")).fontSize),containerWidth=answerSquare.clientWidth,answerContent=answerSquare.querySelector(".answerContent"),newFontSize=3*containerWidth/measureTextWidth(answerContent.textContent,getComputedStyle(answerContent).font)*parseFloat(getComputedStyle(answerContent).fontSize);answerContent.style.fontSize=Math.min(newFontSize,defaultFontSize)+"px"}}function measureTextWidth(text,font){let context=document.createElement("canvas").getContext("2d");context.font=font;let metrics=context.measureText(text);return Math.ceil(metrics.width)}function ZoomIn(){let answersCategories=document.getElementById("answersCategories"),answersGrid=document.getElementById("answersGrid");answersContainer.style.fontSize="0.85em",answersContainer.style.marginTop="2em",answersCategories.style.width="175%",answersGrid.style.width="175%",answersGrid.style.marginBottom="2em",adjustTextSize(),zoomButton.classList.replace("zoomInButton","zoomOutButton"),zoomedIn=!0}function ZoomOut(){let answersCategories=document.getElementById("answersCategories"),answersGrid=document.getElementById("answersGrid");answersContainer.style.removeProperty("font-size"),answersContainer.style.removeProperty("margin-top"),answersCategories.style.removeProperty("width"),answersGrid.style.removeProperty("width"),answersGrid.style.removeProperty("margin-bottom"),adjustTextSize(),zoomButton.classList.replace("zoomOutButton","zoomInButton"),zoomedIn=!1}function ShowZoomButton(){!isZoomDisplayed&&hasAlreadyAnswered&&window.innerWidth<=480&&(zoomContainer.style.display="flex",isZoomDisplayed=!0)}function HideZoomButton(){isZoomDisplayed&&(zoomContainer.style.display="none",isZoomDisplayed=!1)}function ToggleDarkMode(){const newTheme="dark"===GetTheme()?"light":"dark";SetTheme(newTheme),localStorage.setItem("theme",newTheme)}function SetPreferredTheme(){const preferredTheme=localStorage.getItem("theme");preferredTheme?SetTheme(preferredTheme):detectSystemThemeChange(updateTheme)}function SetTheme(theme){document.documentElement.setAttribute("data-theme",theme)}function GetTheme(){return document.documentElement.getAttribute("data-theme")}function detectSystemThemeChange(callback){const mediaQuery=window.matchMedia("(prefers-color-scheme: dark)");SetTheme(mediaQuery.matches?"dark":"light"),mediaQuery.addEventListener("change",callback)}function updateTheme(event){SetTheme(event.matches?"dark":"light")}GetAllCountriesName(),document.addEventListener("DOMContentLoaded",(()=>{SetPreferredTheme(),document.body.classList.replace("hidden","visible")})),window.onload=()=>{console.log("load"),SetPreferredTheme(),detectGame()},gameID||(UpdateCountdownUntilNextCountry(),countdownInterval=setInterval(UpdateCountdownUntilNextCountry,1e3)),countrySubmit.addEventListener("click",(()=>{if(isLoadingCountry||isLoadingCountries)return;let countries=GetTriedCountryBySuggestion(countryInput.value);1===countries.length&&(currentCountry=countries[0].code),SubmitCountry(currentCountry).then((countryData=>{ResolveCountry(countryData)}))})),countryInput.addEventListener("keydown",(e=>TrySubmitCountry(e))),countryInput.addEventListener("input",(e=>UpdateSuggestions(e))),countryInput.addEventListener("click",(e=>UpdateSuggestions(e))),document.addEventListener("DOMContentLoaded",(()=>{window.addEventListener("resize",(()=>{adjustTextSize(),window.innerWidth>480?(HideZoomButton(),zoomedIn&&ZoomOut()):ShowZoomButton()}))})),document.body.addEventListener("click",(e=>{"hidden"!==countryInput.style.visibility&&e.target!==countryInput&&countrySuggestionList.Hide()})),zoomButton.addEventListener("click",(()=>{zoomedIn?ZoomOut():ZoomIn()}));